<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>登录</title>
  <style>
    body { font-family: Arial, Helvetica, sans-serif; padding: 40px; }
    .box { max-width: 360px; margin: 0 auto; }
    input { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; }
    button { width: 100%; padding: 10px; }
    .msg { margin-top: 12px; color: green; min-height: 1.2em; }
    .err { color: red; }
    .row { display:flex; align-items:center; gap:8px; }
    .small { font-size: 0.9em; color: #666; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="box">
    <h2>登录</h2>
    <label for="username">账号</label>
    <input id="username" placeholder="user" autocomplete="username">
    <label for="password">密码</label>
    <input id="password" type="password" placeholder="pass" autocomplete="current-password">
    <div class="row">
      <input id="remember" type="checkbox">
      <label for="remember" class="small">记住密码</label>
    </div>
    <button id="loginBtn">登录</button>

    <div id="status" class="msg" aria-live="polite"></div>
  </div>

  <script>
    function setLocalStorage(key, val){
      try {
        if (val === undefined || val === null) {
          window.localStorage.removeItem(key);
        } else {
          window.localStorage.setItem(key, String(val));
        }
      } catch (e) {
        console.error('setLocalStorage error', e);
      }
    }
    function getLocalStorage(key){
      try {
        return window.localStorage.getItem(key);
      } catch (e) {
        console.error('getLocalStorage error', e);
        return null;
      }
    }

    // 从 URL 中解析查询参数
    function parseQueryParams(url) {
      try {
        const u = new URL(url, window.location.href);
        const params = Object.fromEntries(u.searchParams.entries());
        return params;
      } catch (e) {
        return {};
      }
    }

    document.addEventListener('DOMContentLoaded', function(){
      const usernameEl = document.getElementById('username');
      const passwordEl = document.getElementById('password');
      const rememberEl = document.getElementById('remember');
      const statusEl = document.getElementById('status');
      const loginBtn = document.getElementById('loginBtn');

      // 默认记住密码
      rememberEl.checked = true;

      // 恢复本地已保存的用户名、密码
      const savedUser = getLocalStorage('localUserName');
      const savedPass = getLocalStorage('localUserPassword');
      if (savedUser) usernameEl.value = savedUser;
      if (savedPass) passwordEl.value = savedPass;

      function showMessage(text, isError) {
        statusEl.textContent = text || '';
        statusEl.classList.toggle('err', !!isError);
        statusEl.classList.toggle('msg', !isError);
      }

      loginBtn.addEventListener('click', function(){
        const username = (usernameEl.value || '').trim();
        const password = (passwordEl.value || '').trim();

        // 简单校验
        if (!username) {
          showMessage('请输入用户名', true);
          usernameEl.focus();
          return;
        }
        if (!password) {
          showMessage('请输入密码', true);
          passwordEl.focus();
          return;
        }

        showMessage('正在登录...', false);
        loginBtn.disabled = true;

        fetch('/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        }).then(async res => {
          loginBtn.disabled = false;

          // 解析 JSON
          let data;
          try {
            data = await res.json();
          } catch (e) {
            showMessage('服务器返回了无法解析的响应', true);
            console.error(e);
            return;
          }
          if (data && data.success) {
            showMessage('登录成功，正在跳转...', false);

            // 解析successUrl
            if (data.successUrl) {
              try {
                const params = parseQueryParams(data.successUrl);
                if (params.authToken) setLocalStorage('localAuthToken', params.authToken);
                if (params.username) setLocalStorage('localUserName', params.username);
                // 如果记住密码则保存密码，否则删除
                if (document.getElementById('remember').checked) {
                  setLocalStorage('localUserPassword', password);
                } else {
                  setLocalStorage('localUserPassword', null);
                }

                // 跳转，客户端捕获后视为完成登录
                window.location.href = data.successUrl;
                return;
              } catch (e) {
                showMessage('处理 successUrl 时出错'+e, true);
                return;
              }
            } else {
              showMessage('登录失败', true);
            }
          } else {
            const msg = (data && data.msg) ? data.msg : '登录失败，请检查用户名和密码';
            showMessage(msg, true);
          }
        }).catch(err => {
          console.error('网络错误', err);
          loginBtn.disabled = false;
          showMessage('网络错误' + (err && err.message ? err.message : err), true);
        });
      });
    });
  </script>
</body>
</html>
